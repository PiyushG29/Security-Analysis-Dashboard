<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Analysis Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Security Analysis Dashboard</h1>
            <p class="subtitle">Upload and analyze network traffic data</p>
        </header>

        <div class="upload-section">
            <form action="/upload" method="post" enctype="multipart/form-data">
                <div class="file-upload">
                    <input type="file" id="file" name="file" required>
                    <label for="file">
                        <span class="upload-icon">üìÅ</span>
                        <span class="upload-text">Choose a file or drag it here</span>
                    </label>
                </div>
                <button type="submit" id="submit-btn">Analyze</button>
            </form>
        </div>

        <div id="loading" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Analyzing network traffic...</p>
        </div>

        <div id="results" class="results-container" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card" id="packets-card">
                    <h3>Packets</h3>
                    <div class="stat-value" id="total-packets">0</div>
                    <div class="stat-subtext">Total Packets Analyzed</div>
                </div>
                <div class="stat-card" id="rate-card">
                    <h3>Rate</h3>
                    <div class="stat-value" id="packet-rate">0</div>
                    <div class="stat-subtext">Packets per Second</div>
                </div>
                <div class="stat-card" id="bytes-card">
                    <h3>Data</h3>
                    <div class="stat-value" id="bytes-received">0</div>
                    <div class="stat-subtext">Bytes Received</div>
                </div>
                <div class="stat-card" id="ips-card">
                    <h3>IPs</h3>
                    <div class="stat-value" id="unique-ips">0</div>
                    <div class="stat-subtext">Unique IP Addresses</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>Protocol Distribution</h3>
                    <canvas id="protocol-chart"></canvas>
                </div>
            </div>

            <div class="details-section">
                <div class="detail-card" id="anomalies-section">
                    <h3>Detected Anomalies</h3>
                    <div class="detail-content" id="anomalies-content">No anomalies detected</div>
                </div>
                <div class="detail-card" id="events-section">
                    <h3>Network Events</h3>
                    <div class="detail-content" id="events-content">No events detected</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.querySelector('form');
        const loadingDiv = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        const submitBtn = document.getElementById('submit-btn');
        let protocolChart = null;

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num.toFixed(0);
        }

        function formatBytes(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        function updateStats(stats) {
            document.getElementById('total-packets').textContent = formatNumber(stats.total_packets);
            document.getElementById('packet-rate').textContent = formatNumber(stats.packet_rate);
            document.getElementById('bytes-received').textContent = formatBytes(stats.bytes_received);
            document.getElementById('unique-ips').textContent = formatNumber(stats.unique_ips);

            // Update protocol chart
            if (protocolChart) {
                protocolChart.destroy();
            }

            const protocols = stats.protocols;
            const ctx = document.getElementById('protocol-chart').getContext('2d');
            protocolChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(protocols),
                    datasets: [{
                        data: Object.values(protocols),
                        backgroundColor: [
                            '#4CAF50',
                            '#2196F3',
                            '#FFC107',
                            '#9C27B0',
                            '#F44336'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        function updateDetails(data) {
            // Update anomalies
            const anomaliesContent = document.getElementById('anomalies-content');
            if (data.anomalies && data.anomalies.length > 0) {
                anomaliesContent.innerHTML = data.anomalies.map(anomaly => 
                    `<div class="detail-item">${JSON.stringify(anomaly, null, 2)}</div>`
                ).join('');
            } else {
                anomaliesContent.innerHTML = `<div class="detail-item empty-state">
                    <div class="empty-icon">üîç</div>
                    <div class="empty-message">No anomalies detected in the analysis</div>
                </div>`;
            }

            // Update network events
            const eventsContent = document.getElementById('events-content');
            if (data.network_events && data.network_events.length > 0) {
                eventsContent.innerHTML = data.network_events.map(event => 
                    `<div class="detail-item">${JSON.stringify(event, null, 2)}</div>`
                ).join('');
            } else {
                eventsContent.innerHTML = `<div class="detail-item empty-state">
                    <div class="empty-icon">üìä</div>
                    <div class="empty-message">No network events detected</div>
                </div>`;
            }

            // Add context section
            const detailsSection = document.querySelector('.details-section');
            const existingContextCard = document.getElementById('context-section');
            
            if (!existingContextCard) {
                const contextCard = document.createElement('div');
                contextCard.className = 'detail-card';
                contextCard.id = 'context-section';
                contextCard.innerHTML = `
                    <h3>Analysis Context</h3>
                    <div class="detail-content" id="context-content"></div>
                `;
                detailsSection.appendChild(contextCard);
            }

            const contextContent = document.getElementById('context-content');
            if (data.context && Object.keys(data.context).length > 0) {
                contextContent.innerHTML = `<div class="detail-item">${JSON.stringify(data.context, null, 2)}</div>`;
            } else {
                contextContent.innerHTML = `<div class="detail-item empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-message">No additional context available</div>
                </div>`;
            }

            // Add raw stats section
            const existingStatsCard = document.getElementById('raw-stats-section');
            
            if (!existingStatsCard) {
                const statsCard = document.createElement('div');
                statsCard.className = 'detail-card';
                statsCard.id = 'raw-stats-section';
                statsCard.innerHTML = `
                    <h3>Raw Statistics</h3>
                    <div class="detail-content" id="raw-stats-content"></div>
                `;
                detailsSection.appendChild(statsCard);
            }

            const statsContent = document.getElementById('raw-stats-content');
            statsContent.innerHTML = `<div class="detail-item">${JSON.stringify(data.stats, null, 2)}</div>`;
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);

            // Show loading state
            loadingDiv.style.display = 'flex';
            resultsDiv.style.display = 'none';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (response.ok) {
                    // Update the UI with results
                    updateStats(data.results.stats);
                    updateDetails(data.results);
                    resultsDiv.style.display = 'block';
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                // Hide loading state
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // File upload visual feedback
        const fileInput = document.getElementById('file');
        const uploadLabel = document.querySelector('.file-upload label');

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadLabel.classList.add('has-file');
                uploadLabel.querySelector('.upload-text').textContent = e.target.files[0].name;
            } else {
                uploadLabel.classList.remove('has-file');
                uploadLabel.querySelector('.upload-text').textContent = 'Choose a file or drag it here';
            }
        });

        // Drag and drop support
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, () => {
                uploadLabel.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, () => {
                uploadLabel.classList.remove('drag-over');
            });
        });

        uploadLabel.addEventListener('drop', (e) => {
            fileInput.files = e.dataTransfer.files;
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        });
    </script>
</body>
</html>
